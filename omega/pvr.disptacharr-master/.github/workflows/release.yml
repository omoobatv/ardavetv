name: Release Zips

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            label: linux
    name: Build ${{ matrix.label }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Kodi dev kit (headers)
        shell: bash
        run: |
          git clone --depth 1 --branch 21.3-Omega https://github.com/xbmc/xbmc xbmc
          if [[ ! -f "xbmc/xbmc/addons/kodi-dev-kit/include/kodi/addon-instance/PVR.h" ]]; then
            echo "ERROR: Could not find kodi-dev-kit/include/kodi/addon-instance/PVR.h"
            exit 1
          fi

      - name: Install build deps (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        timeout-minutes: 15
        run: |
          sudo apt-get update -y
          sudo apt-get install -y cmake build-essential zip g++ libpugixml-dev libcurl4-openssl-dev 2>&1 | tail -20
          echo "Build dependencies installed successfully"

      - name: Install build deps (Windows)
        if: startsWith(matrix.os, 'windows')
        timeout-minutes: 15
        shell: pwsh
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          choco install zip -y
          choco install curl -y
          echo "Build dependencies installed successfully"

      - name: Build and stage addon
        shell: bash
        timeout-minutes: 45
        env:
          KODI_ADDON_SDK: xbmc/xbmc/addons/kodi-dev-kit
          VERSION: ${{ github.event_name == 'release' && github.event.release.tag_name || '' }}
          CMAKE_GENERATOR: ${{ matrix.cmake_generator }}
          CMAKE_GENERATOR_PLATFORM: ${{ matrix.cmake_generator_platform }}
        run: |
          echo "KODI_ADDON_SDK=$KODI_ADDON_SDK"
          ls -la "$KODI_ADDON_SDK/include/kodi/addon-instance/" || true
          if [[ -n "$VERSION" ]]; then
            VERSION="${VERSION#v}"  # Strip 'v' prefix
            ./build.sh --skip-zip --version "$VERSION" 2>&1
          else
            ./build.sh --skip-zip 2>&1
          fi
          ls -lah dist


      - name: Check shared library deps (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        run: |
          set -e
          ADDON_DIR="dist/pvr.dispatcharr"
          if [[ ! -d "$ADDON_DIR" ]]; then echo "Addon directory not found: $ADDON_DIR"; ls -lah dist || true; exit 1; fi
          SO_FILE=$(find "$ADDON_DIR" -name '*.so' -print -quit)
          if [[ -z "$SO_FILE" ]]; then echo "No .so found in $ADDON_DIR"; find "$ADDON_DIR" -maxdepth 2 -type f -print; exit 1; fi
          echo "Found SO: $SO_FILE"
          ldd "$SO_FILE" | tee /dev/stderr
          if ldd "$SO_FILE" | grep -q "not found"; then echo "Missing shared dependencies"; exit 1; fi
          echo "Linux shared library dependencies OK"

      - name: Check shared library deps (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: bash
        run: |
          set -e
          ADDON_DIR="dist/pvr.dispatcharr"
          if [[ ! -d "$ADDON_DIR" ]]; then echo "Addon directory not found: $ADDON_DIR"; ls -lah dist || true; exit 1; fi
          DLL_FILE=$(find "$ADDON_DIR" -name '*.dll' -print -quit)
          if [[ -z "$DLL_FILE" ]]; then echo "No .dll found in $ADDON_DIR"; find "$ADDON_DIR" -maxdepth 2 -type f -print; exit 1; fi
          echo "Found DLL: $DLL_FILE"
          file "$DLL_FILE" || true
          # Check DLL architecture using dumpbin (from MSVC toolset)
          if command -v dumpbin.exe &>/dev/null; then
            echo "Checking DLL architecture with dumpbin:"
            dumpbin.exe //HEADERS "$DLL_FILE" | grep -A3 "FILE HEADER VALUES" || true
            dumpbin.exe //HEADERS "$DLL_FILE" | grep "machine" || true
          fi
          echo "Windows DLL found and checked"

      - name: Set version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Strip 'v' prefix if present
          else
            VERSION="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Create release ZIP
        if: github.event_name == 'release'
        shell: bash
        env:
          MATRIX_OS: ${{ matrix.os }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -e
          case "$MATRIX_OS" in
            ubuntu-*) PLAT=linux ;;
            windows-*) PLAT=windows ;;
            *) PLAT="$MATRIX_OS" ;;
          esac
          mkdir -p release-zips
          ZIP_NAME="pvr.dispatcharr-${VERSION}-${PLAT}.zip"
          (cd dist && zip -qr "../release-zips/$ZIP_NAME" pvr.dispatcharr)
          echo "Created release ZIP: $ZIP_NAME"
          ls -lah release-zips/*.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.dispatcharr-${{ steps.version.outputs.version }}-${{ matrix.label }}
          path: dist

      - name: Publish GitHub Release asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: release-zips/*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        abi: [armeabi-v7a, arm64-v8a]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Kodi dev kit (headers)
        shell: bash
        run: |
          git clone --depth 1 --branch 21.3-Omega https://github.com/xbmc/xbmc xbmc
          if [[ ! -f "xbmc/xbmc/addons/kodi-dev-kit/include/kodi/addon-instance/PVR.h" ]]; then
            echo "ERROR: Could not find kodi-dev-kit/include/kodi/addon-instance/PVR.h"
            exit 1
          fi

      - name: Set up NDK
        timeout-minutes: 20
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d

      - name: Install build deps (Android)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libpugixml-dev 2>&1 | tail -20
          echo "Android build dependencies installed"

      - name: Build curl for Android
        env:
          ANDROID_ABI: ${{ matrix.abi }}
        run: |
          NDK_PATH="${ANDROID_NDK_ROOT:-${ANDROID_NDK_HOME}}"
          
          # Download curl source
          curl -L https://curl.se/download/curl-8.5.0.tar.gz -o curl.tar.gz
          tar xzf curl.tar.gz
          cd curl-8.5.0
          
          # Set up Android toolchain
          if [ "$ANDROID_ABI" = "armeabi-v7a" ]; then
            TARGET_HOST=armv7a-linux-androideabi
            TOOLCHAIN_PREFIX=armv7a-linux-androideabi
          elif [ "$ANDROID_ABI" = "arm64-v8a" ]; then
            TARGET_HOST=aarch64-linux-android
            TOOLCHAIN_PREFIX=aarch64-linux-android
          elif [ "$ANDROID_ABI" = "x86" ]; then
            TARGET_HOST=i686-linux-android
            TOOLCHAIN_PREFIX=i686-linux-android
          elif [ "$ANDROID_ABI" = "x86_64" ]; then
            TARGET_HOST=x86_64-linux-android
            TOOLCHAIN_PREFIX=x86_64-linux-android
          fi
          
          export ANDROID_NDK=$NDK_PATH
          export TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          export API=21
          export AR=$TOOLCHAIN/bin/llvm-ar
          export CC=$TOOLCHAIN/bin/${TOOLCHAIN_PREFIX}${API}-clang
          export CXX=$TOOLCHAIN/bin/${TOOLCHAIN_PREFIX}${API}-clang++
          export LD=$TOOLCHAIN/bin/ld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          ./configure --host=$TARGET_HOST \
            --prefix=$PWD/../curl-android \
            --disable-shared \
            --enable-static \
            --without-ssl \
            --without-zlib \
            --disable-dict \
            --disable-ftp \
            --disable-imap \
            --disable-ldap \
            --disable-ldaps \
            --disable-pop3 \
            --disable-rtsp \
            --disable-smtp \
            --disable-telnet \
            --disable-tftp
          
          make -j$(nproc)
          make install
          
          echo "CURL_ROOT=$PWD/../curl-android" >> $GITHUB_ENV
          echo "Curl built for Android $ANDROID_ABI"

      - name: Build addon (Android)
        timeout-minutes: 45
        env:
          KODI_ADDON_SDK: xbmc/xbmc/addons/kodi-dev-kit
          VERSION: ${{ github.event_name == 'release' && github.event.release.tag_name || '' }}
        run: |
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME"
          ls -la "$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake" || ls -la "$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" || find /usr/local -name "android.toolchain.cmake" 2>/dev/null | head -1
          NDK_PATH="${ANDROID_NDK_ROOT:-${ANDROID_NDK_HOME}}"
          if [ -z "$NDK_PATH" ]; then
            echo "ERROR: NDK not found"
            exit 1
          fi
          export CMAKE_EXTRA_ARGS="-DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake -DANDROID_ABI=${{ matrix.abi }} -DANDROID_PLATFORM=android-21 -DCURL_ROOT=$CURL_ROOT -DCURL_INCLUDE_DIR=$CURL_ROOT/include -DCURL_LIBRARY=$CURL_ROOT/lib/libcurl.a"
          if [[ -n "$VERSION" ]]; then
            VERSION="${VERSION#v}"  # Strip 'v' prefix
            ./build.sh --skip-zip --version "$VERSION"
          else
            ./build.sh --skip-zip
          fi
          ls -lah dist

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Strip 'v' prefix if present
          else
            VERSION="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Create release ZIP
        if: github.event_name == 'release'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -e
          mkdir -p release-zips
          ZIP_NAME="pvr.dispatcharr-${VERSION}-android-${{ matrix.abi }}.zip"
          (cd dist && zip -qr "../release-zips/$ZIP_NAME" pvr.dispatcharr)
          echo "Created release ZIP: $ZIP_NAME"
          ls -lah release-zips/*.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.dispatcharr-${{ steps.version.outputs.version }}-android-${{ matrix.abi }}
          path: dist

      - name: Publish GitHub Release asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: release-zips/*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
